<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>N-Mail | 메일 수정</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="my.css">
  <script src="shared.js"></script>
  <style>.is-invalid + .invalid-feedback{display:block}</style>
</head>
<body>
  <div class="d-flex" style="min-height:100vh;">
    <!-- Sidebar -->
    <div class="sidebar d-flex flex-column flex-shrink-0 p-3" style="width: 260px;">
      <div class="d-flex align-items-center mb-3 brand">
        <p style="color: var(--nv); font-size: 30px; font-weight: bolder; padding-right: 5px;">N </p>
        <p style="font-size: 20px; font-weight:lighter;"> 메일</p>
      </div>
      <a href="index.html" class="btn btn-outline-secondary mb-3">목록</a>
      <a href="add.html" class="btn btn-success mb-3" style="background:var(--nv); border:0;">메일쓰기</a>
    </div>

    <!-- Main -->
    <main class="flex-grow-1 p-3 container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0">메일 수정 (데모: 저장 안 함)</h3>
        <a class="btn btn-outline-secondary" id="cancelLink" href="index.html">목록</a>
      </div>

      <div id="alertBox"></div>
      <form id="f" class="card p-3" novalidate></form>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const id = getParam('id');
    let item = null;

    // 샘플 메일 처리
    if(id === 'sample-1'){
      item = {
        id: 'sample-1',
        from: '박헌일 <22100324@handong.ac.kr>',
        subject: '과제 제출 합니다!',
        date: new Date().toISOString(),
        folder: '받은편지함',
        hasAttachment: true,
        starred: true,
        snippet: '과제 제출 성공적,,'
      };
    } else if(isValidId(id)){
      item = findById(id) || null;
    }

    const f = document.getElementById('f');
    const alertBox = document.getElementById('alertBox');
    const cancelLink = document.getElementById('cancelLink');
    if(item) cancelLink.href = 'view.html?id='+encodeURIComponent(id);

    function showAlert(type, html){
      alertBox.innerHTML =
        `<div class="alert alert-${type} alert-dismissible" role="alert">
          ${html}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }
    const val = (v)=>esc(v??'');

    if(item){
      f.innerHTML = `
        <div class="row g-3">
          <div class="col-md-8">
            <label class="form-label">제목 *</label>
            <input name="subject" class="form-control" required value="${val(item.subject)}">
            <div class="invalid-feedback">제목은 2자 이상 100자 이하.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">보낸사람 *</label>
            <input name="from" class="form-control" required value="${val(item.from)}">
            <div class="invalid-feedback">보낸사람은 필수.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">폴더 *</label>
            <select name="folder" class="form-select" required>
              ${['받은편지함','보낸편지함','중요','임시보관함'].map(op=>`<option ${op===item.folder?'selected':''}>${esc(op)}</option>`).join('')}
            </select>
            <div class="invalid-feedback">폴더를 선택하세요.</div>
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check me-3">
              <input class="form-check-input" type="checkbox" name="starred" id="starred" ${item.starred?'checked':''}>
              <label class="form-check-label" for="starred">중요 표시</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="hasAttachment" id="hasAttachment" ${item.hasAttachment?'checked':''}>
              <label class="form-check-label" for="hasAttachment">첨부파일 있음</label>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">본문 *</label>
            <textarea name="snippet" class="form-control" rows="6" required>${val(item.snippet)}</textarea>
            <div class="form-text">최소 10자, 최대 3000자.</div>
            <div class="invalid-feedback">본문은 10~3000자.</div>
          </div>
        </div>
        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-primary" type="submit">수정</button>
          <a class="btn btn-outline-secondary" href="${cancelLink.href}">취소</a>
        </div>
      `;
    } else {
      f.innerHTML = '<div>잘못된 접근이거나 항목이 없습니다. <a class="link-primary" href="index.html">목록으로</a></div>';
    }

    function setInvalid(input, invalid){
      input.classList.toggle('is-invalid', invalid);
      input.classList.toggle('is-valid', !invalid);
    }

    f.addEventListener('submit', (e)=>{
      e.preventDefault(); if(!item) return;
      const fd = new FormData(f);
      const subject=(fd.get('subject')||'').trim();
      const from=(fd.get('from')||'').trim();
      const folder=(fd.get('folder')||'').trim();
      const snippet=(fd.get('snippet')||'').trim();
      const starred=fd.get('starred')==='on';
      const hasAttachment=fd.get('hasAttachment')==='on';

      let ok=true; const errs=[];
      if(subject.length<2 || subject.length>100){ ok=false; errs.push('제목 2~100자'); }
      if(!from){ ok=false; errs.push('보낸사람 필수'); }
      if(!folder){ ok=false; errs.push('폴더 필수'); }
      if(snippet.length<10 || snippet.length>3000){ ok=false; errs.push('본문 10~3000자'); }

      setInvalid(f.elements.subject, !(subject.length>=2 && subject.length<=100));
      setInvalid(f.elements.from, !from);
      setInvalid(f.elements.folder, !folder);
      setInvalid(f.elements.snippet, !(snippet.length>=10 && snippet.length<=3000));

      if(!ok){ showAlert('danger', `<strong>유효성 검사 실패</strong><br>${errs.map(esc).join('<br>')}`); return; }

      if(confirm('게시물을 수정할까요?')){
        alert('게시물이 수정되었습니다.');
        location.href = 'view.html?id=' + encodeURIComponent(item.id);
      }
    });
  </script>
</body>
</html>
